{"version":3,"file":"OpenMPS-Server.js","sourceRoot":"","sources":["OpenMPS-Server.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env node\nimport * as fs from 'fs';\n// @ts-ignore\nimport * as config from './config.json';\nimport * as https from 'https';\nimport * as express from 'express';\nimport * as MysqlConnector from './MySQLConnector';\nimport * as MySQLConnectorForManastone from './MySQLConnectorForManastone';\n\n\nlet mysqlConnectionManager = new MysqlConnector.sql.MySQLConnector;\nlet mysqlConnectionManagerManastone = new MySQLConnectorForManastone.sql.MySQLConnectorForManastone;\n\nlet app = express();\nlet options = {\n    key: fs.readFileSync(config.CertPath.key),\n    cert: fs.readFileSync(config.CertPath.cert)\n};\nlet server = https.createServer(options, app);\nlet io = require('socket.io')(server);\n\nconst Version = \"1.000.0001.0000\";\n\n\n/**\n * Socket.io Server Handler\n * Reacts on incoming Connections\n */\nio.on('connection', (socket) => {\n    //   socket.emit('info', Version);\n    mysqlConnectionManager.insertServerLog(socket.id.toString(), \" Connection Opened\");\n\n\n    /**\n     * Handles incoming OidRequest\n     * Sends the latest Oid Table, if the token is in the Database\n     */\n    socket.on('OidRequest', (token) => {\n        let tokenData = JSON.parse(token)\n        try {\n            mysqlConnectionManagerManastone.checkIfTokenExists(tokenData.Token).then(tokenRow => {\n\n                let a = tokenRow;\n                if (tokenRow[0].TokenCheck == 1){\n                mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New OidRequest\");\n                mysqlConnectionManager.retrieveOidTable().then(row => {\n                    socket.emit(\"OidOffer\", JSON.stringify(row));\n\n                });\n                } else {\n                    socket.emit(\"OidOffer\", \"[]\");\n\n                }\n            });\n\n        } catch (e) {\n            console.log(e);\n        }\n    });\n\n    /**\n     * Handles incoming SendData\n     * Inserts a OidDataSet into the Database\n     */\n    socket.on('SendData', (data) => {\n        try {\n            mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New Data\");\n            mysqlConnectionManager.insertOidSet(JSON.parse(data));\n            sendSimpleResult(socket, true);\n        } catch (e) {\n            sendSimpleResult(socket, false);\n        }\n\n    });\n\n    /**\n     * Handles incoming OidVersionRequest\n     * Sends the latest Oid Version\n     */\n    socket.on('OidVersionRequest', () => {\n        mysqlConnectionManager.retrieveOidVersion().then(row => {\n                mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New OidVersionRequest\");\n                socket.emit(\"OidVersionOffer\", JSON.stringify(row[0]));\n            }\n        );\n    });\n\n    /**\n     * Handles incoming MPSVersionRequest\n     * Sends the latest MPS Version\n     */\n    socket.on('MPSVersionRequest', () => {\n        mysqlConnectionManager.retrieveMPSVersion().then(row => {\n                mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New MPSVersionRequest\");\n                socket.emit(\"MPSVersion\", JSON.stringify(row[0]));\n            }\n        );\n    });\n\n    /**\n     * Handles incoming MPSMinClientVersionRequest\n     * Sends the latest MPS Version\n     */\n    socket.on('MPSMinClientVersionRequest', () => {\n        mysqlConnectionManager.retrieveMPSMinClientVersion().then(row => {\n                mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New MPSMinClientVersionRequest\");\n                socket.emit(\"MPSMinClientVersionOffer\", JSON.stringify(row[0]));\n            }\n        );\n    });\n\n    /**\n     * Disconnect event\n     * Inserts Connection closed message into the Serverlog Table\n     */\n    socket.on('disconnect', () => {\n        mysqlConnectionManager.insertServerLog(socket.id.toString(), \"Connection Closed\");\n    });\n});\n\n/**\n * Sends a SimpleResult\n * @param socket\n * @param res\n * @constructor\n */\nfunction sendSimpleResult(socket, res: boolean = false): void {\n    socket.emit('closer', JSON.stringify({Result: res}));\n    socket.disconnect();\n}\n\n/**\n * Entry Point of the Socket.io server\n * Starts the server and outputs Version and Port\n */\nserver.listen(config.ServerPort, () => {\n    mysqlConnectionManager.insertServerLog(\"\", \"openMPS Server: \"\n        + Version + \" Listening on: \" + config.ServerPort);\n    console.log('openMPS Server V %s, Listening on %s', Version, config.ServerPort);\n});"]}